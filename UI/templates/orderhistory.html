<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>the shop. | your orders</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    <!-- Custom styles for this template -->
    <link rel="stylesheet" href="{{ url_for('static', filename='homepage.css')}}">

</head>
<body>
    <header>
        {% include 'nav.html' %}
    </header>

    <div class="container">
        <div class="container-sm" id="main-container">
            <img src="{{pic}}" class="rounded-circle" height="45em"> 
            &nbsp;{{user}}
        </div>
        <div class="container-sm">
            <table class="table" id="orderTable">
                <thead>
                    <tr>
                        <th scope="col">Order ID</th>
                        <th scope="col">Items</th>
                        <th scope="col">Seller</th>
                        <th scope="col">Order Status</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                    
                    </tr>
                </tbody>
              </table>
        </div>
    </div>


    <script src="https://kit.fontawesome.com/b7cadf2b6a.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
        crossorigin="anonymous"></script>

    <script>
        function showError(message) {
        // Hide the table and button in the event of error
        $('#orderTable').hide();
 
        // Display an error under the main container
        $('#main-container')
            .append("<label>"+message+"</label>");
        }

        async function createCustomer(address, name){
            var myHeaders = new Headers();
            myHeaders.append("Content-Type", "application/json");

            var raw = JSON.stringify({
            "custAddress": address,
            "custName": name
            });

            var requestOptions = {
            method: 'POST',
            headers: myHeaders,
            body: raw,
            redirect: 'follow'
            };

            const response_ = await fetch("http://localhost:9292/customers/createCustomers", requestOptions)
            .then(response => response.text())
            .then(result => console.log(result))
            .catch(error => console.log('error', error));
                return response_;
        };

        async function getOrders(custID) {
            console.log(custID)
        }


        $(async () => {           
            // Change serviceURL to your own
            var customerURL = "http://localhost:9292/customers";
            var findCustomer = customerURL + '/{{user}}';
            
            try {
                const response =
                await fetch(
                    findCustomer, 
                    { method: 'GET' }
                );
                
                const result = await response.json();
                console.log(result)

                if (response.status === 404) {

                    $('#orderTable').hide();
                    $('#main-container').append("<label> You have not purchased from us before</label>");

                    var createNewCust = customerURL + '/createCustomers';
                
                    const createResponse = await createCustomer('', '{{user}}');

                    console.log(createResponse.json().custID)

                    } 
                
                else if (response.status === 200) {
                    var custID = result.data.custID
                    getOrders(custID)
                };

            } catch (error) {
                showError(error);
            }
        });

    </script>
</body>
</html>