<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>the shop. | Home</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    <!-- Custom styles for this template -->
    <link rel="stylesheet" href="{{ url_for('static', filename='homepage.css')}}">
</head>

<body>
    <!-- header contains the top bar: logo, search bar, login, cart -->
    <header>
        <!-- <img class="logo" src="{{url_for('static', filename='images/logo_goes_here.png')}}" alt="logo"> -->
        <h2>the shop.</h2>
        <nav>
            <ul class="nav-links">
                <li class="searchbar">
                    <input type="text" placeholder="Search">
                    <a href="#"><i class="fa-solid fa-magnifying-glass"></i></a>
                </li>
                <li><a href="/login">Login</a></li>
                <li><a href="/cart">Cart</a></li>
            </ul>
        </nav>
    </header>

    <section>
        <div class="container pb-5 px-lg-5" id="main-container">
            <h2 class="text-center m-4">Daily Discover</h2>
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 px-md-5" id="productCards"></div>
        </div>
    </section>

    <script>
        // Helper function to display error message
        function showError(message) {
            // Hide the table and button in the event of error
            $('#main-container').hide();
            // $('#addBookBtn').hide();

            // Display an error under the main container
            $('#main-container')
            .append("<label>" + message + "</label>");
        }

        $(async () => {
            // Change serviceURL to your own
            var serviceURL = "http://127.0.0.1:9090/items";

            try {
                const response =
                    await fetch(
                        serviceURL, { method: 'GET' }
                    );
                const result = await response.json();
                if (response.status === 200) {
                    // success case
                    var items = result;

                    window.localStorage.setItem("items", JSON.stringify(items))


                    items.forEach(item => {

                        var imgFileName = "static/images/" + item.id + "-1.jpeg";
                        card=`<div className="col">
                                <div class="card shadow-sm">
                                    <img class="card-img-top bg-dark cover" alt="${item.productName}" src=${imgFileName}>
                                    <div class="card-body">
                                        <h5 class="card-title text-center">${item.productName}</h5>
                                        <p class="card-text text-center text-muted">SGD ${item.itemPrice}</p>

                                        <div class="d-grid gap-2">
                                            <a href="/productDetails/${item.id}" class="btn btn-outline-dark"">Details</a>
                                            <a href="#" class="btn btn-primary shop-item-button">Add to Cart</a>
                                        </div>
                                    </div>
                                </div>
                            </div>`;

                        document.getElementById("productCards").innerHTML += card;
                    });

                } else if (response.status == 404) {
                    // No books
                    showError(result.message);
                } else {
                    // unexpected outcome, throw the error
                    throw response.status;
                }
            } catch (error) {
                // Errors when calling the service; such as network error,
                // service offline, etc
                showError
                    ('There is a problem retrieving product data, please try again later.<br />' + error);
            } // error
        });

        var addToCartButtons = document.getElementsByClassName('shop-item-button')
            for (var i = 0; i < addToCartButtons.length; i++) {
                var button = addToCartButtons[i]
                button.addEventListener('click', addToCartClicked)
            }

        function addToCartClicked(event) {
                var button = event.target
                var shopItem = button.parentElement.parentElement
                var title = shopItem.getElementsByClassName('shop-item-title')[0].innerText
                var price = shopItem.getElementsByClassName('shop-item-price')[0].innerText
                var imageSrc = shopItem.getElementsByClassName('shop-item-image')[0].src
                addItemToCart(title, price, imageSrc)
                updateCartTotal()
            }

        function updateCartTotal() {
                var cartItemContainer = document.getElementsByClassName('cart-items')[0]
                var cartRows = cartItemContainer.getElementsByClassName('cart-row')
                var total = 0
                for (var i = 0; i < cartRows.length; i++) {
                    var cartRow = cartRows[i]
                    var priceElement = cartRow.getElementsByClassName('cart-price')[0]
                    var quantityElement = cartRow.getElementsByClassName('cart-quantity-input')[0]
                    var price = parseFloat(priceElement.innerText.replace('$', ''))
                    var quantity = quantityElement.value
                    total = total + (price * quantity)
                }
                total = Math.round(total * 100) / 100
                document.getElementsByClassName('cart-total-price')[0].innerText = '$' + total
            }



    </script>


    <script src="https://kit.fontawesome.com/b7cadf2b6a.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
        crossorigin="anonymous"></script>

</body>

</html>